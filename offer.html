<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NeoPrint - Teklif Al</title>

  <!-- Teklif sayfasÄ± CSS -->
  <link rel="stylesheet" href="/offer.css" />

</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-left">
      <a href="/index.html">
        <!-- logo -->
        <img src="/img/logo.png" alt="NeoPrint Logo" class="logo" />
      </a>
      <span class="brand">NeoPrint</span>
    </div>
    <div class="nav-right">
      <a href="/index.html" class="btn small">â¬… Geri DÃ¶n</a>
    </div>
  </nav>

  <!-- Loader -->
  <div id="loader" class="loader-overlay" style="display: none;">
    <div class="spinner"></div>
  </div>

  <!-- Ä°Ã§erik -->
  <main class="container">
    <h2>3D BaskÄ± Ä°Ã§in Teklif Al</h2>

    <form id="offerForm" class="offer-form" enctype="multipart/form-data">
      <!-- Dosya yÃ¼kleme -->
      <div class="file-upload">
        <label for="file" class="custom-file-label">
          ğŸ“‚ Dosya SeÃ§
        </label>
        <input
          type="file"
          id="file"
          name="files"
          accept=".stl,.obj,.zip"
          multiple
          hidden
        />
        <p>Desteklenen tipler: STL, OBJ, ZIP | Max: 16MB</p>
        <div id="fileList" class="file-list"></div>
      </div>

      <!-- Filament tÃ¼rÃ¼ -->
      <label>
        Filament TÃ¼rÃ¼ SeÃ§imi*
        <select name="filament" required>
          <option value="">SeÃ§iniz</option>
          <option value="PLA+">PLA+</option>
          <option value="PETG">PETG</option>
          <option value="ABS">ABS</option>
          <option value="ASA">ASA</option>
          <option value="TPU">TPU</option>
          <option value="PLA-CF">PLA-CF</option>
          <option value="DiÄŸer">DiÄŸer</option>
        </select>
      </label>

      <!-- Adet / Renk -->
      <div class="grid">
        <label>
          Adet*
          <input type="number" name="quantity" min="1" required />
        </label>

        <label>
          Renk*
          <select name="color" required>
            <option value="Siyah">Siyah</option>
            <option value="Beyaz">Beyaz</option>
            <option value="KÄ±rmÄ±zÄ±">KÄ±rmÄ±zÄ±</option>
            <option value="Mavi">Mavi</option>
            <option value="YeÅŸil">YeÅŸil</option>
          </select>
        </label>
      </div>

      <!-- Doluluk / Katman -->
      <div class="grid">
        <label>
          Doluluk OranÄ± % (infill)
          <input type="number" name="infill" min="0" max="100" value="20" />
        </label>

        <label>
          Katman YÃ¼ksekliÄŸi (Layer Height)
          <select name="layer">
            <option value="0.12">0,12 mm</option>
            <option value="0.16">0,16 mm</option>
            <option value="0.20" selected>0,20 mm</option>
            <option value="0.28">0,28 mm</option>
          </select>
        </label>
      </div>

      <!-- Teslim tarihi -->
      <label>
        Talep EttiÄŸiniz Teslim Tarihi
        <input type="date" name="deliveryDate" required />
      </label>

      <!-- Ek aÃ§Ä±klamalar -->
      <label>
        Ek AÃ§Ä±klamalar
        <textarea
          name="details"
          placeholder="Teknik gereksinimler, Ã¶zel talepler..."
        ></textarea>
      </label>

      <!-- Ä°sim / Soyisim -->
      <div class="grid">
        <label>
          AdÄ±nÄ±z*
          <input type="text" name="firstName" required />
        </label>

        <label>
          SoyadÄ±nÄ±z*
          <input type="text" name="lastName" required />
        </label>
      </div>

      <!-- Mail / Telefon -->
      <div class="grid">
        <label>
          E-posta*
          <input type="email" name="email" required />
        </label>

        <label>
          Telefon NumaranÄ±z*
          <input
            type="tel"
            id="phone"
            name="phone"
            placeholder="0XXXXXXXXXX"
            pattern="^0[0-9]{10}$"
            required
          />
        </label>
      </div>

      <!-- KVKK -->
      <div class="kvkk">
        <input type="checkbox" id="consent" required />
        <label for="consent">
          KiÅŸisel verilerimin iÅŸlenmesine onay veriyorum.
          <a href="#" id="showPolicy">AydÄ±nlatma Metni</a>
        </label>
      </div>

      <button type="submit" class="btn-primary">Teklif Al</button>
    </form>
  </main>

  <!-- KVKK Modal -->
  <div id="policyModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>AydÄ±nlatma Metni</h2>
      <p>
        6698 sayÄ±lÄ± KiÅŸisel Verilerin KorunmasÄ± Kanunu (â€œKVKKâ€) kapsamÄ±nda,
        tarafÄ±mÄ±za iletmiÅŸ olduÄŸunuz ad, soyad, telefon numarasÄ±, e-posta
        adresi ve sipariÅŸ detaylarÄ± gibi kiÅŸisel verileriniz; 3D baskÄ±
        talebinizin deÄŸerlendirilmesi, size teklif sunulmasÄ± ve sÃ¼reÃ§ boyunca
        gerekli iletiÅŸimin saÄŸlanmasÄ± amacÄ±yla iÅŸlenecektir.
      </p>
      <p>
        KiÅŸisel verileriniz, yalnÄ±zca belirtilen amaÃ§larla sÄ±nÄ±rlÄ± kalmak
        kaydÄ±yla iÅŸlenecek olup, Ã¼Ã§Ã¼ncÃ¼ kiÅŸilerle izniniz olmaksÄ±zÄ±n
        paylaÅŸÄ±lmayacaktÄ±r. KVKKâ€™nÄ±n 11. maddesi kapsamÄ±nda veri sahibi olarak
        her zaman haklarÄ±nÄ±za iliÅŸkin baÅŸvuru yapabilirsiniz.
      </p>
      <p>
        DetaylÄ± bilgi iÃ§in <strong>www.kvkk.gov.tr</strong> adresini ziyaret
        edebilirsiniz.
      </p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>
</body>
</html>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // === CONFIG ===
  const API_BASE = "https://neoprintbe-production.up.railway.app";
  const UPLOAD_URL = API_BASE + "/upload-offer";
  // === ELEMENTS ===
  const form = document.getElementById("offerForm");
  const loader = document.getElementById("loader");
  const fileInput = document.getElementById("file");
  const fileList = document.getElementById("fileList");
  const toast = document.getElementById("toast");

  // modal
  const modal = document.getElementById("policyModal");
  const link = document.getElementById("showPolicy");
  const closeBtn = document.querySelector(".close");

  // phone
  const phoneInput = document.getElementById("phone");

  // === STATE ===
  let selectedFiles = [];
  const allowedExtensions = [".stl", ".obj", ".zip"];
  const MAX_SIZE = 16 * 1024 * 1024;

  // === HELPERS ===
  function showToast(message, success = true) {
    toast.innerText = message;
    toast.style.backgroundColor = success ? "#28a745" : "#dc3545";
    toast.className = "toast show";
    setTimeout(() => (toast.className = toast.className.replace("show", "")), 3000);
  }

  function setLoading(isLoading) {
    if (!loader) return;
    loader.style.display = isLoading ? "flex" : "none";
  }

  function renderFileList() {
    fileList.innerHTML = "";

    selectedFiles.forEach((file, index) => {
      const div = document.createElement("div");
      div.className = "file-item";
      div.innerHTML = `
        <span>${file.name} <span class="file-size">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span></span>
        <button type="button" data-index="${index}">âŒ</button>
      `;
      fileList.appendChild(div);
    });

    // delete handlers
    fileList.querySelectorAll("button[data-index]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const i = Number(btn.dataset.index);
        selectedFiles.splice(i, 1);
        renderFileList();
      });
    });
  }

  // === FILE CHANGE (TEK) ===
  fileInput.addEventListener("change", () => {
    const files = Array.from(fileInput.files || []);
    if (!files.length) return;

    let invalidExt = false;
    let invalidSize = false;
    let addedAny = false;

    files.forEach((file) => {
      const dot = file.name.lastIndexOf(".");
      const ext = dot >= 0 ? file.name.substring(dot).toLowerCase() : "";

      if (!allowedExtensions.includes(ext)) {
        invalidExt = true;
        return;
      }

      if (file.size > MAX_SIZE) {
        invalidSize = true;
        return;
      }

      const exists = selectedFiles.some((f) => f.name === file.name && f.size === file.size);
      if (!exists) {
        selectedFiles.push(file);
        addedAny = true;
      }
    });

    if (invalidExt) showToast("âœ– Sadece STL, OBJ veya ZIP yÃ¼kleyebilirsiniz!", false);
    if (invalidSize) showToast("âœ– Maksimum dosya boyutu 16MB!", false);

    renderFileList();

    // âš ï¸ input'u change iÃ§inde boÅŸaltmak bazÄ± ortamlarda dialogu bozabiliyor.
    // O yÃ¼zden burada SIFIRLAMIYORUZ.
    // AynÄ± dosyayÄ± tekrar seÃ§mek istersen, silip yeniden seÃ§ebilirsin.
  });

  // === SUBMIT (TEK) ===
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // validations
    const filament = form.querySelector("[name='filament']")?.value?.trim();
    const email = form.querySelector("[name='email']")?.value?.trim();

    if (!selectedFiles.length) return showToast("âœ– LÃ¼tfen bir dosya seÃ§in!", false);
    if (!filament) return showToast("âœ– Filament tÃ¼rÃ¼nÃ¼ seÃ§iniz!", false);
    if (!email || !email.includes("@")) return showToast("âœ– GeÃ§erli bir e-posta giriniz!", false);

    const formData = new FormData();
    selectedFiles.forEach((file) => formData.append("files", file));

    // other fields (boÅŸsa boÅŸ gider)
    [
      "firstName",
      "lastName",
      "email",
      "phone",
      "filament",
      "quantity",
      "color",
      "infill",
      "layer",
      "deliveryDate",
      "details",
    ].forEach((name) => {
      const v = form.querySelector(`[name='${name}']`)?.value ?? "";
      formData.append(name, v);
    });

    setLoading(true);

    try {
      const res = await fetch(UPLOAD_URL, { method: "POST", body: formData });
      if (!res.ok) throw new Error(`Sunucu hatasÄ±: ${res.status}`);

      const text = await res.text();
      showToast("âœ” " + text, true);

      form.reset();
      selectedFiles = [];
      renderFileList();
    } catch (err) {
      showToast("âœ– Hata: " + err.message, false);
    } finally {
      setLoading(false);
    }
  });

  // === MODAL ===
  if (link && modal && closeBtn) {
    link.addEventListener("click", (e) => {
      e.preventDefault();
      modal.style.display = "block";
    });
    closeBtn.addEventListener("click", () => (modal.style.display = "none"));
    window.addEventListener("click", (e) => {
      if (e.target === modal) modal.style.display = "none";
    });
  }

  // === PHONE FORMAT ===
  if (phoneInput) {
    phoneInput.addEventListener("input", () => {
      let val = phoneInput.value;
      if (!val.startsWith("0")) val = "0" + val.replace(/^0+/, "");
      if (val.length > 11) val = val.slice(0, 11);
      phoneInput.value = val;
    });
  }
});


</script>